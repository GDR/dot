# NixOS Module System Architecture

This document describes the module system architecture for this NixOS/nix-darwin dotfiles repository.

## Overview

The system uses two types of modules:
1. **System modules** (`_systemAll`, `_systemLinux`, `_systemDarwin`) - system-wide configuration
2. **User modules** (`modules_v2/common/`) - per-user packages enabled via tags

## Directory Structure

```
modules_v2/
├── _systemAll/           # Cross-platform system modules (Linux + Darwin)
│   ├── shell/
│   │   ├── ssh.nix
│   │   └── git.nix
│   ├── fonts.nix
│   ├── nix-gc.nix
│   └── nix-settings.nix
├── _systemLinux/         # Linux-only system modules
│   ├── desktop/
│   │   └── hyprland/
│   ├── graphics/
│   │   └── nvidia.nix
│   ├── keyboards/
│   │   └── keychron.nix
│   ├── networking/
│   │   ├── networkmanager.nix
│   │   └── tailscale.nix
│   └── sound.nix
├── _systemDarwin/        # Darwin-only system modules
│   └── default.nix
└── common/               # User modules (tag-based)
    ├── browsers/
    ├── desktop/
    ├── downloads/
    ├── editors/
    ├── games/
    ├── media/
    ├── security/
    ├── shell/
    └── terminal/
```

## System Modules

System modules configure system-wide services, drivers, and settings. They are:
- Enabled explicitly via `systemAll.*`, `systemLinux.*`, or `systemDarwin.*` options
- NOT controlled by tags
- Can include user packages via `home-manager.users` if needed

### Creating a System Module

```nix
# modules_v2/_systemLinux/example/example.nix
{ config, pkgs, lib, ... }: with lib;
let
  cfg = config.systemLinux.example;
  enabledUsers = filterAttrs (_: u: u.enable) config.hostUsers;
in
{
  options.systemLinux.example = {
    enable = mkEnableOption "Example system module";
    # Add other options as needed
  };

  config = mkIf cfg.enable {
    # System-level configuration
    services.example.enable = true;

    # Optional: User packages (applied to all enabled users)
    home-manager.users = mapAttrs
      (username: _: {
        home.packages = [ pkgs.example-tool ];
      })
      enabledUsers;
  };
}
```

### Enabling in Host Config

```nix
# hosts/nix-goldstar/default.nix
systemAll = {
  fonts.enable = true;
  nix-settings.enable = true;
  shell.ssh.enable = true;
};

systemLinux = {
  desktop.hyprland.enable = true;
  graphics.nvidia.enable = true;
  sound.enable = true;
};
```

## User Modules (Tag-Based)

User modules install packages for specific users based on tags. They:
- Live in `modules_v2/common/`
- Use `mkModuleV2` helper which handles everything (meta, options, config, shouldEnable)
- Are enabled when a user has the module's tag in `hostUsers.<user>.tags.enable`

### Creating a User Module (Simple)

```nix
# modules_v2/common/category/example.nix
{ lib, pkgs, ... }@args:

lib.my.mkModuleV2 args {
  tags = [ "example-tag" ];
  description = "Example module description";
  module = {
    nixosSystems = {
      home.packages = [ pkgs.example ];
    };
    darwinSystems = {
      homebrew.casks = [ "example" ];
    };
  };
}
```

### With Live-Editable Dotfiles

```nix
# modules_v2/common/terminal/ghostty/ghostty.nix
{ lib, pkgs, ... }@args:

lib.my.mkModuleV2 args {
  tags = [ "terminal" ];
  description = "Ghostty terminal emulator";
  module = {
    nixosSystems = {
      home.packages = [ pkgs.ghostty ];
    };
    darwinSystems = {
      homebrew.casks = [ "ghostty" ];
    };
  };
  dotfiles = {
    path = "ghostty";  # ~/.config/ghostty
    source = "modules_v2/common/terminal/ghostty/dotfiles";
  };
}
```

### mkModuleV2 Parameters

| Parameter | Required | Description |
|-----------|----------|-------------|
| `tags` | Yes | Tags that enable this module |
| `description` | No | Module description |
| `platforms` | No | Default: `["linux" "darwin"]` |
| `requires` | No | Module dependencies |
| `module` | No | Platform-specific config (see below) |
| `dotfiles` | No | `{ path, source }` for live-editable configs |

### Module Sections

```nix
module = {
  nixosSystems = {
    home.packages = [ ... ];      # Linux home-manager
  };
  darwinSystems = {
    homebrew.casks = [ ... ];     # macOS homebrew
  };
  allSystems = {
    home.packages = [ ... ];      # Both platforms
  };
};
```

### Enabling via Tags in Host Config

```nix
# hosts/nix-goldstar/default.nix
hostUsers.dgarifullin = importUser "dgarifullin" // {
  enable = true;
  tags.enable = [
    "browsers"
    "core"
    "desktop-utils"
    "editors-terminal"
    "example-tag"  # Enables the example module
  ];
};
```

## Live-Editable Dotfiles

For modules with config files that should be editable without rebuilding, use the `dotfiles` parameter in `mkModuleV2`:

```nix
lib.my.mkModuleV2 args {
  tags = [ "terminal" ];
  module = { ... };
  dotfiles = {
    path = "example";  # ~/.config/example
    source = "modules_v2/common/category/example/dotfiles";
  };
}
```

This creates a symlink: `~/.config/example` → `repo/modules_v2/common/.../dotfiles`

For advanced cases (manual module structure), use `mkDotfilesSymlink` directly:

```nix
home-manager.users = lib.my.mkDotfilesSymlink {
  inherit config self;
  path = "example";
  source = "modules_v2/common/category/example/dotfiles";
};
```

## Host Users System

Users are defined in `hosts/_users/` with defaults, then enabled per-host:

```nix
# hosts/_users/username.nix
{ lib, ... }: {
  fullName = lib.mkDefault "Full Name";
  email = lib.mkDefault "email@example.com";
  github = lib.mkDefault "github-username";
  extraGroups = lib.mkDefault [ "wheel" "networkmanager" ];
}
```

```nix
# hosts/hostname/default.nix
hostUsers.username = importUser "username" // {
  enable = true;
  keys = [{
    name = "keyname";
    type = "rsa";
    purpose = [ "git" "ssh" ];
    isDefault = true;
  }];
  tags.enable = [ "tag1" "tag2" ];
};
```

## Common Tags Reference

| Tag | Description |
|-----|-------------|
| `browsers` | Web browsers (chromium) |
| `core` | Core utilities (htop) |
| `desktop-utils` | Desktop utilities (rofi, dunst, audio controls) |
| `desktop-utils-wayland` | Wayland-specific (waybar, grim, slurp) - requires hyprland |
| `downloads` | Download managers (qbittorrent) |
| `editors-terminal` | Terminal editors (neovim) |
| `editors-ui` | GUI editors (cursor) |
| `games` | Gaming (steam) |
| `media` | Media players (vlc) |
| `security` | Security tools (keepassxc) |
| `shells` | Shell configs (zsh) |
| `terminal` | Terminal emulators (ghostty) |

## Key Helper Functions

- `lib.my.mkModuleV2 args { tags, module, dotfiles?, ... }` - **Preferred** - Complete module generator
- `lib.my.mkModule system config cfg` - Creates platform-aware config (for manual modules)
- `lib.my.mkModuleConfig { system, config, self, module, dotfiles? }` - Combines mkModule + dotfiles
- `lib.my.shouldEnableModule { config, modulePath, moduleTags }` - Checks if module should be enabled
- `lib.my.mkModuleOptions modulePath options` - Creates module options at correct path
- `lib.my.mkModuleMeta { tags, platforms, description }` - Module metadata
- `lib.my.mkDotfilesSymlink { config, self, path, source }` - Live-editable dotfiles symlink

## Adding New Modules Checklist

1. **Decide scope**: System (`_system*`) or User (`common/`)
2. **Choose category**: Pick or create appropriate subdirectory
3. **Create module file** using templates above
4. **For system modules**: Add import to `_system*/default.nix`
5. **For user modules**: Auto-discovered, just add tag to host config
6. **Stage new files**: `git add` before `nix flake check` (Nix needs staged files)
7. **Test**: Run `nix flake check`

## SSH Keys Configuration

Keys are defined per-host in `hostUsers.<user>.keys`:

```nix
keys = [{
  name = "goldstar";      # Key identifier
  type = "rsa";           # Key type (rsa, ed25519)
  purpose = [ "git" "ssh" ];  # Array: "git" for signing, "ssh" for auth
  isDefault = true;       # Default key for this host
}];
```

**Key path convention**: `~/.ssh/<name>_id_<type>` (e.g., `~/.ssh/goldstar_id_rsa`)

The SSH and Git modules in `_systemAll/shell/` read these keys automatically.

## Important Patterns & Gotchas

### System vs User Module Differences

| Aspect | System Module | User Module |
|--------|---------------|-------------|
| Location | `_system*` | `modules_v2/common/` |
| Enable | `systemLinux.*.enable = true` | Via tags |
| Pattern | Manual `{ options, config }` | `mkModuleV2 args { ... }` |
| Uses `meta` | No | Yes (auto-generated) |
| Auto-discovered | No (needs import) | Yes |

### Conditional Module Enablement

For modules that depend on system config (e.g., Wayland utils needing Hyprland):

```nix
let
  waylandEnabled = config.systemLinux.desktop.hyprland.enable or false;
in
mkIf (shouldEnable && waylandEnabled) (mkModule { ... });
```

### Desktop Entries for App Launchers (Rofi)

If an app doesn't appear in Rofi/app launchers, add a desktop entry:

```nix
home-manager.users.username.xdg.desktopEntries.appname = {
  name = "App Name";
  exec = "${pkgs.appname}/bin/appname";
  icon = "appname";
  type = "Application";
  categories = [ "Category" ];
};
```

### Avoiding Package Conflicts

Don't combine `programs.X` with `home.packages = [ pkgs.X ]` - they conflict:

```nix
# BAD - conflicts
programs.chromium.enable = true;
home.packages = [ pkgs.chromium ];

# GOOD - use one or the other
programs.chromium.enable = true;
```

### Hardware Configuration

Boot and hardware settings go in `hardware-configuration.nix`, NOT host `default.nix`:

```nix
# hosts/hostname/hardware-configuration.nix
boot.kernelPackages = pkgs.linuxPackages_latest;
boot.loader.systemd-boot.enable = true;
boot.loader.efi.canTouchEfiVariables = true;
```

### Home Manager Option Paths

Common path mistakes:
- `home.xdg.desktopEntries` ❌ → `xdg.desktopEntries` ✓
- `home.programs.zsh` ❌ → `programs.zsh` ✓ (inside home-manager context)

### Deprecation Warnings

Check for deprecation warnings in build output. Common fixes:
- `programs.ssh.addKeysToAgent` → `programs.ssh.matchBlocks.*.addKeysToAgent`
- `programs.git.userEmail` → `programs.git.settings.user.email`

### Theme/Config Files in Dotfiles

For apps like Ghostty that need theme files, include them in the dotfiles folder:

```
modules_v2/common/terminal/ghostty/
├── ghostty.nix
└── dotfiles/
    ├── config
    └── themes/
        └── catppuccin-mocha  # Theme file
```

## File Organization Guidelines

- **Drivers/WM/DE** → `_systemLinux` (system-wide, not user-specific)
- **Keyboards/udev** → `_systemLinux` (system-level hardware config)
- **Network services** → `_systemLinux/networking/` or `_systemAll/`
- **User apps** → `modules_v2/common/` with appropriate tags
- **Cross-platform system** → `_systemAll/` (fonts, nix settings, git, ssh)

## Don't

- Don't use grep across monorepo root (user preference)
- Don't put boot config in host default.nix
- Don't mix `programs.X` and `home.packages = [X]`
- Don't forget to `git add` new files before `nix flake check`
- Don't use `meta` in system modules (causes errors)
