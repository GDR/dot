---
description: NixOS module system architecture (system + user modules)
globs: ["modules/**/*.nix", "lib/**/*.nix"]
alwaysApply: true
---

# Overview
- System modules (`systems/all`, `systems/linux`, `systems/darwin`): System-wide config, enabled via `systemAll.*`/`systemLinux.*`/`systemDarwin.*`
- User modules (`modules/home/`): Per-user packages, enabled via hierarchical paths in `hostUsers.<user>.modules.<path>.enable`

# System Modules
Location: `systems/{all,linux,darwin}`, enabled: `systemLinux.*.enable = true`, pattern: `mkSystemModuleV2 args { namespace, module, ... }`, uses `meta`: No, auto-discovered: No (needs import)

```nix
# modules/systems/linux/graphics/nvidia.nix
{ lib, pkgs, config, ... }@args:

lib.my.mkSystemModuleV2 args {
  namespace = "linux";
  description = "NVIDIA graphics drivers";
  module = cfg: {
    services.xserver.videoDrivers = [ "nvidia" ];
    hardware.nvidia = {
      open = cfg.open or false;
      modesetting.enable = true;
    };
  };
  extraOptions = {
    open = lib.mkOption {
      default = false;
      type = lib.types.bool;
      description = "Use open-source NVIDIA drivers";
    };
  };
}
```

Enable: `systemLinux.graphics.nvidia.enable = true;` in host config.

# User Modules
Location: `modules/home/`, enabled: Via hierarchical paths, pattern: `mkModuleV2 args { module, systemModule?, dotfiles?, ... }`, uses `meta`: Yes (auto), auto-discovered: Yes

## Simple
```nix
# modules/home/browsers/vivaldi.nix
{ lib, pkgs, ... }@args:

lib.my.mkModuleV2 args {
  description = "Vivaldi browser";
  module = {
    allSystems.home.packages = [ pkgs.vivaldi ];
  };
}
```

## With Dotfiles
```nix
# modules/home/terminal/ghostty/ghostty.nix
lib.my.mkModuleV2 args {
  description = "Ghostty terminal emulator";
  module = {
    allSystems.home.packages = [ pkgs.ghostty ];
  };
  dotfiles = {
    path = "ghostty";  # ~/.config/ghostty
    source = "modules/home/terminal/ghostty/dotfiles";
  };
}
```
Creates symlink: `~/.config/ghostty` → `repo/modules/home/terminal/ghostty/dotfiles`

## With System-Level Config
```nix
# modules/home/desktop/hyprland/hyprland.nix
{ lib, pkgs, config, ... }@args:
let
  enabledUsers = lib.filterAttrs (_: u: u.enable) (config.hostUsers or { });
in

lib.my.mkModuleV2 args {
  description = "Hyprland compositor";
  systemModule = {
    nixosSystems = {
      programs.hyprland.enable = true;
      services.greetd.enable = true;
      xserver.enable = true;
    };
  };
  module = {
    nixosSystems.home.packages = [ pkgs.hyprland ];
  };
  dotfiles = {
    path = "hyprland";
    source = "modules/home/desktop/hyprland/dotfiles";
  };
}
```

## mkModuleV2 Params
- `description`: Module description
- `platforms`: Default `["linux" "darwin"]`
- `requires`: List of module paths this depends on
- `module`: Platform config (attrset or `cfg -> attrset`)
- `systemModule`: System-level config (attrset or `cfg -> attrset`)
- `dotfiles`: `{ path, source }` for live-editable configs
- `extraOptions`: Additional options (merged with `enable`)
- `imports`: Sub-module imports

## Platform Sections
```nix
module = {
  allSystems.home.packages = [ ... ];      # Both platforms
  nixosSystems.home.packages = [ ... ];   # Linux only
  darwinSystems.homebrew.casks = [ ... ];  # macOS only
};

systemModule = {
  nixosSystems = { programs.nixvim.enable = true; }; # Linux system-level
  darwinSystems = { ... };                           # macOS system-level
  allSystems = { programs.zsh.enable = true; };     # Both platforms
};
```

## Custom Options
```nix
lib.my.mkModuleV2 args {
  description = "Zsh shell";
  extraOptions = {
    showHostname = lib.mkOption {
      default = true;
      type = lib.types.bool;
      description = "Show hostname in prompt";
    };
  };
  module = cfg: {
    allSystems.home.packages = [ pkgs.zsh ];
    # Access: cfg.showHostname
  };
}
```

## Module Imports
```nix
lib.my.mkModuleV2 args {
  description = "Neovim editor";
  imports = [
    ./dotfiles/colorschema.nix
    ./dotfiles/general.nix
    ./dotfiles/plugins/airline.nix
  ];
  systemModule = {
    allSystems.programs.nixvim.enable = true;
  };
  module = {
    allSystems.home.packages = [ pkgs.ripgrep pkgs.fzf ];
  };
}
```

## Enable via Hierarchical Paths
```nix
hostUsers.dgarifullin = importUser "dgarifullin" // {
  enable = true;
  modules = {
    home.browsers.enable = true;           # All browsers
    home.browsers.vivaldi.enable = true;   # Just vivaldi
    home.desktop.hyprland.enable = true;
    home.editors.enable = true;
  };
};
```

# mkSystemModuleV2 Params
- `namespace` (req): `"all"` | `"linux"` | `"darwin"`
- `description`: Module description
- `module`: Config (attrset or `cfg -> attrset`)
- `moduleLinux`: Linux-specific additions (for `namespace = "all"`)
- `moduleDarwin`: Darwin-specific additions (for `namespace = "all"`)
- `extraOptions`: Additional options
- `imports`: Sub-module imports

# Helpers
- `lib.my.mkModuleV2 args { module, systemModule?, dotfiles?, imports?, ... }` - **User modules**
- `lib.my.mkSystemModuleV2 args { namespace, module, moduleLinux?, moduleDarwin?, ... }` - **System modules**
- `lib.my.shouldEnableModule { config, modulePath }` - Check if module enabled (hierarchical)
- `lib.my.getUsersWithModule { config, modulePath }` - Get users with module enabled
- `lib.my.mkDotfilesSymlink { config, self, path, source }` - Dotfiles symlink
- `lib.my.mkUsersAttrs usernames fn` - Creates `users.users` attrset

# Hierarchical Enablement
Module enabled if:
- `modules.home.browsers.vivaldi.enable = true` (specific)
- OR `modules.home.browsers.enable = true` (category)
- OR `modules.home.enable = true` (all home)
- OR `hostUsers.<user>.modules.home.browsers.enable = true` (per-user)

Path follows directory: `modules/home/<category>/<module>` → `modules.home.<category>.<module>`

# Module Paths
- User: `modules.home.<category>.<module>` (e.g., `modules.home.browsers.vivaldi`)
- System: `systemAll.*`, `systemLinux.*`, `systemDarwin.*` (transformed from `systems.all.*`, etc.)

# Adding Modules Checklist
1. Decide scope: System (`systems/*`) or User (`home/*`)
2. Choose category: Pick/create subdirectory
3. Create module file using templates above
4. System modules: Add import to `systems/*/default.nix`
5. User modules: Auto-discovered, just add path to `hostUsers.<user>.modules`
6. Stage: `git add` before `nix flake check` (Nix needs staged files)
7. Test: `nix flake check`

# SSH Keys
Defined per-host in `hostUsers.<user>.keys`:
```nix
keys = [{
  name = "goldstar";      # Key identifier
  type = "rsa";           # rsa, ed25519
  purpose = [ "git" "ssh" ];  # "git" for signing, "ssh" for auth
  isDefault = true;       # Default key for this host
}];
```
Path convention: `~/.ssh/<name>_id_<type>` (e.g., `~/.ssh/goldstar_id_rsa`)
SSH/Git modules in `systems/all/shell/` read these automatically.

# Gotchas

## Conditional Enablement
```nix
let
  waylandEnabled = config.modules.home.desktop.hyprland.enable or false;
in
mkIf (shouldEnable && waylandEnabled) (mkModule { ... });
```

## Desktop Entries (Rofi)
If app doesn't appear in Rofi:
```nix
home-manager.users.username.xdg.desktopEntries.appname = {
  name = "App Name";
  exec = "${pkgs.appname}/bin/appname";
  icon = "appname";
  type = "Application";
  categories = [ "Category" ];
};
```

## Package Conflicts
Don't combine `programs.X` with `home.packages = [ pkgs.X ]`:
```nix
# BAD
programs.chromium.enable = true;
home.packages = [ pkgs.chromium ];

# GOOD
programs.chromium.enable = true;
```

## Hardware Config
Boot/hardware → `hardware-configuration.nix`, NOT host `default.nix`.

## Home Manager Paths
- `home.xdg.desktopEntries` ❌ → `xdg.desktopEntries` ✓
- `home.programs.zsh` ❌ → `programs.zsh` ✓ (inside home-manager context)

## Deprecation Warnings
- `programs.ssh.addKeysToAgent` → `programs.ssh.matchBlocks.*.addKeysToAgent`
- `programs.git.userEmail` → `programs.git.settings.user.email`

## Theme Files
For apps like Ghostty, include theme files in dotfiles folder:
```
modules/home/terminal/ghostty/
├── ghostty.nix
└── dotfiles/
    ├── config
    └── themes/catppuccin-mocha
```

# File Organization
- Drivers/WM/DE → `systems/linux/` or `home/desktop/` (if user-choice)
- Keyboards/udev → `systems/linux/` (system-level hardware)
- Network services → `systems/linux/networking/` or `systems/all/`
- User apps → `home/` with hierarchical paths
- Cross-platform system → `systems/all/` (fonts, nix settings, git, ssh)

# Don't
- Don't use grep across monorepo root (user preference)
- Don't put boot config in host default.nix
- Don't mix `programs.X` and `home.packages = [X]`
- Don't forget `git add` before `nix flake check`
- Don't use tags - use hierarchical paths (`modules.home.browsers.enable`)
