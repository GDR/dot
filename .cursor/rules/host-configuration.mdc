---
description: Host and user configuration guide
globs: ["hosts/**/*.nix"]
alwaysApply: true
---

# Structure
```
hosts/
├── users/
│   └── dgarifullin.nix    # User defaults (shared)
├── machines/
│   └── nix-goldstar/
│       ├── default.nix        # Host config
│       └── hardware-configuration.nix  # Hardware/boot
└── mac-blackstar/
    └── default.nix
```

# Host Template
```nix
# hosts/machines/hostname/default.nix
{ inputs, lib, config, pkgs, home-manager, hardware, ... }:
let
  importUser = name: import ../../users/${name}.nix { inherit lib; };
in
{
  imports = [ ./hardware-configuration.nix ];

  hostUsers.username = importUser "username" // {
    enable = true;
    keys = [{
      name = "hostname";
      type = "rsa";
      purpose = [ "git" "ssh" ];
      isDefault = true;
    }];
    # Hierarchical module enables (NOT tags)
    modules = {
      home.browsers.enable = true;
      home.cli.enable = true;
      home.desktop = {
        appearance.enable = true;
        services.enable = true;
        widgets.enable = true;
        utils.enable = true;
        hyprland.enable = true;  # or awesomewm.enable
      };
      home.downloads.enable = true;
      home.editors.enable = true;
      home.games.enable = true;
      home.media.enable = true;
      home.messengers.enable = true;
      home.security.enable = true;
      home.shell.enable = true;
      home.terminal.enable = true;
      home.virtualisation.enable = true;
    };
  };

  networking.hostName = "hostname";

  systemAll = {
    fonts.enable = true;
    nix.settings.enable = true;
    nix.gc.enable = true;
    shell = { ssh.enable = true; git.enable = true; };
  };

  systemLinux = {
    networking = {
      networkmanager.enable = true;
      tailscale.enable = true;
    };
    graphics.nvidia.enable = true;
    sound.enable = true;
  };

  time.timeZone = "Europe/Moscow";
}
```

# User Defaults
```nix
# hosts/users/username.nix
{ lib, ... }: {
  fullName = lib.mkDefault "Full Name";
  email = lib.mkDefault "email@example.com";
  github = lib.mkDefault "github-username";
  extraGroups = lib.mkDefault [ "wheel" "networkmanager" "docker" ];
  # Keys NOT in defaults - host-specific
}
```

# Hardware Config
```nix
# hosts/machines/hostname/hardware-configuration.nix
{ config, lib, pkgs, modulesPath, ... }:
{
  imports = [ (modulesPath + "/installer/scan/not-detected.nix") ];

  boot.kernelPackages = pkgs.linuxPackages_latest;
  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;

  fileSystems."/" = { ... };
  hardware.cpu.intel.updateMicrocode = true;
}
```

# What Goes Where
| Setting | Location |
|---------|----------|
| User modules | `default.nix` → `hostUsers.<user>.modules` |
| System modules | `default.nix` → `systemAll`/`systemLinux`/`systemDarwin` |
| Hostname | `default.nix` → `networking.hostName` |
| Timezone | `default.nix` → `time.timeZone` |
| Boot loader | `hardware-configuration.nix` |
| Kernel | `hardware-configuration.nix` |
| Filesystems | `hardware-configuration.nix` |
| Hardware drivers | `hardware-configuration.nix` or `systemLinux` modules |

# Hierarchical Enables
- `home.enable = true` → enables ALL home modules
- `home.browsers.enable = true` → enables all browsers
- `home.browsers.vivaldi.enable = true` → enables just vivaldi
- Path follows directory: `modules/home/<category>/<module>`

# Add Host
1. Create `hosts/machines/new-hostname/default.nix`
2. Create `hosts/machines/new-hostname/hardware-configuration.nix`
3. Add to `flake.nix`: `nixosConfigurations.new-hostname = mkNixosConfiguration ./hosts/machines/new-hostname;`
4. Generate: `nixos-generate-config --show-hardware-config`

# Add User
1. Create `hosts/users/newuser.nix` with defaults
2. In host config:
```nix
hostUsers.newuser = importUser "newuser" // {
  enable = true;
  keys = [{ ... }];
  modules = { home.browsers.enable = true; };
};
```
