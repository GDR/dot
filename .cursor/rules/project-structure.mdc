---
description: NixOS dotfiles repository structure
globs: ["**/*.nix"]
alwaysApply: true
---

# Structure
```
dot/
├── .cursor/rules/      # AI rules
├── flake.nix           # Entry point
├── hosts/              # Host configs
│   ├── users/          # User defaults
│   └── machines/       # Machine configs
├── lib/                # Helpers/core modules
├── modules/            # Module system
│   ├── _core/          # Core (registry, user)
│   ├── home/           # User modules
│   └── systems/        # System modules
├── overlays/           # Nixpkgs overlays
├── pkgs/               # Custom packages
└── templates/          # Flake templates
```

# Key Files
- `flake.nix`: Inputs, mkNixosConfiguration/mkDarwinConfiguration, exports configs
- `lib/default.nix`: mkModuleV2, mkSystemModuleV2, shouldEnableModule, mkDotfilesSymlink, platform detection
- `lib/modules_v2/user.nix`: hostUsers option, creates users.users + home-manager.users, SSH/Git integration
- `modules/_core/user.nix`: hostUsers option definition

# modules Structure
```
modules/
├── _core/              # Core system
│   ├── registry.nix    # Module discovery
│   └── user.nix         # hostUsers option
├── home/                # User modules (hierarchical enables)
│   ├── browsers/{chromium,vivaldi}.nix
│   ├── cli/{htop,shell-utils}.nix
│   ├── desktop/
│   │   ├── appearance/cursor.nix
│   │   ├── awesomewm/awesomewm.nix
│   │   ├── hyprland/hyprland.nix
│   │   ├── services/{audio,brightness,notifications}.nix
│   │   ├── utils/wayland.nix
│   │   └── widgets/{launcher,network-applet}.nix
│   ├── downloads/qbittorrent.nix
│   ├── editors/{cursor,neovim}/
│   ├── games/steam.nix
│   ├── media/{spotify,vlc}.nix
│   ├── messengers/telegram.nix
│   ├── security/{bitwarden,keepassxc}.nix
│   ├── shell/{tmux,zsh}/
│   ├── terminal/ghostty/
│   ├── utils/{macfuse,raycast}.nix
│   └── virtualisation/docker.nix
└── systems/             # System modules
    ├── all/             # Cross-platform
    │   ├── fonts.nix
    │   ├── nix/{gc,settings}.nix
    │   └── shell/{git,ssh}.nix
    ├── darwin/          # macOS-only
    │   ├── app-aliases.nix
    │   ├── homebrew.nix
    │   └── macos-settings.nix
    └── linux/           # Linux-only
        ├── editors/vscode-server.nix
        ├── graphics/nvidia.nix
        ├── keyboards/keychron.nix
        ├── networking/{networkmanager,tailscale}.nix
        └── sound.nix
```

# Discovery
- System (`systems/*`): Manual import in default.nix
- User (`home/*`): Auto-discovered via lib.my.recursiveDirs

# Naming
- System dirs: `systems/{all,darwin,linux}`
- Module files: `modulename.nix` or `modulename/modulename.nix`
- Dotfiles: `modulename/dotfiles/`
- Host dirs: `hosts/machines/hostname/` (matches networking.hostName)
- User defaults: `hosts/users/username.nix`

# Module Paths
- User: `modules.home.<category>.<module>` (e.g., `modules.home.browsers.vivaldi`)
- System: `systemAll.*`, `systemLinux.*`, `systemDarwin.*` (transformed from `systems.all.*`, etc.)
